<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Veh√≠culos | Parqueadero</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">Parqueadero Autos Colombia</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="vehiculos.html">Veh√≠culos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="usuarios.html">Usuarios</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="espacios.html">Espacios</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="pagos.html">Pagos</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-5">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5>Registrar Veh√≠culo</h5>
                    </div>
                    <div class="card-body">
                        <form id="vehiculoForm">
                            <div class="mb-3">
                                <label class="form-label">Placa*</label>
                                <input type="text" class="form-control" id="placa" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Marca*</label>
                                <input type="text" class="form-control" id="marca" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Modelo*</label>
                                <input type="text" class="form-control" id="modelo" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Color*</label>
                                <input type="text" class="form-control" id="color" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tipo*</label>
                                <select class="form-select" id="tipo" required>
                                    <option value="carro">Carro</option>
                                    <option value="moto">Moto</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Documento del Due√±o*</label>
                                <input type="text" class="form-control" id="propietario" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Registrar</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-7">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5>Veh√≠culos en Parqueadero</h5>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Placa</th>
                                    <th>Marca</th>
                                    <th>Modelo</th>
                                    <th>Color</th>
                                    <th>Tipo</th>
                                    <th>Due√±o</th>
                                    <th>Espacio</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="vehiculosTable">

                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const API_BASE = 'http://localhost:4000';
            const API_VEHICULOS = `${API_BASE}/api/vehiculos`;
            const API_USUARIOS = `${API_BASE}/api/usuarios`;

            async function mostrarError(mensaje) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger';
                errorDiv.textContent = mensaje;
                document.querySelector('.container').prepend(errorDiv);
                setTimeout(() => errorDiv.remove(), 5000);
            }

            async function cargarVehiculos() {
                try {
                    const response = await fetch(API_VEHICULOS);

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Error al cargar veh√≠culos');
                    }

                    const vehiculos = await response.json();
                    const tbody = document.getElementById('vehiculosTable');
                    tbody.innerHTML = '';

                    vehiculos.forEach(v => {
                        const row = `<tr>
                <td>${v.placa}</td>
                <td>${v.marca}</td>
                <td>${v.modelo || 'N/A'}</td>
                <td>${v.color || 'N/A'}</td>
                <td>${v.tipo || 'N/A'}</td>
                <td>${v.propietario?.documento || 'N/A'}</td>
                <td>${v.espacioAsignado?.codigo || 'N/A'}</td>
                <td>
                    <button class="btn btn-sm btn-danger" 
                            onclick="registrarSalida('${v._id}')">
                        Salida
                    </button>
                </td>
            </tr>`;
                        tbody.innerHTML += row;
                    });
                } catch (error) {
                    console.error("Error detallado:", error);
                    alert("Error al cargar veh√≠culos: " + error.message);
                }
            }

            async function registrarVehiculo(e) {
                e.preventDefault();
                const btnSubmit = e.target.querySelector('button[type="submit"]');

                try {
                    btnSubmit.disabled = true;
                    btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Registrando...';

                    const response = await fetch(API_VEHICULOS, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            placa: document.getElementById('placa').value,
                            marca: document.getElementById('marca').value,
                            modelo: document.getElementById('modelo').value,
                            color: document.getElementById('color').value,
                            tipo: document.getElementById('tipo').value,
                            propietarioDoc: document.getElementById('propietario').value
                        })
                    });

                    const resultado = await response.json();

                    if (!response.ok) {
                        if (resultado.error === 'PARQUEADERO_LLENO') {
                            throw new Error(`üöó‚ùå ¬°Parqueadero lleno! (${resultado.ocupados}/${resultado.capacidad} ocupados)`);
                        }
                        throw new Error(resultado.message || 'Error al registrar veh√≠culo');
                    }

                    alert(`‚úÖ Veh√≠culo registrado exitosamente!\nEspacio asignado: ${resultado.espacio}`);
                    document.getElementById('vehiculoForm').reset();
                    cargarVehiculos();

                } catch (error) {
                    console.error("Error:", error);
                    alert(error.message);
                } finally {
                    btnSubmit.disabled = false;
                    btnSubmit.textContent = 'Registrar';
                }
            }

            async function forzarRegistro(placa) {
                try {
                    const response = await fetch(`${API_VEHICULOS}/forzar`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('adminToken')
                        },
                        body: JSON.stringify({ placa })
                    });

                } catch (error) {
                    console.error('Error al forzar registro:', error);
                }
            }


            document.getElementById('vehiculoForm').addEventListener('submit', registrarVehiculo);

            window.registrarSalida = async (id) => {
                if (!confirm("¬øRegistrar salida del veh√≠culo?")) return;
                try {
                    const response = await fetch(`${API_VEHICULOS}/${id}/salida`, {
                        method: 'PATCH'
                    });
                    if (!response.ok) throw new Error('Error al registrar salida');
                    cargarVehiculos();
                    alert("Salida registrada");
                } catch (error) {
                    console.error("Error:", error);
                    alert("Error: " + error.message);
                }
            };

            cargarVehiculos();
        });
    </script>
</body>

</html>